(function(p,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],n):(p=typeof globalThis<"u"?globalThis:p||self,n(p.ThreeViewportGizmo={},p.THREE))})(this,function(p,n){"use strict";var nt=Object.defineProperty;var at=(p,n,b)=>n in p?nt(p,n,{enumerable:!0,configurable:!0,writable:!0,value:b}):p[n]=b;var d=(p,n,b)=>(at(p,typeof n!="symbol"?n+"":n,b),b);const b=(t,e,i)=>{const a=document.createElement("div"),r=a.style,{top:o,left:s,right:c,bottom:h}=i;r.height=`${e}px`,r.width=`${e}px`,r.borderRadius="100%",r.position="absolute",r.background="#fff3",r.opacity="0",r.zIndex="10000";const[l,u]=t.split("-");return r.transform="",r.margin=`${o}px ${c}px ${h}px ${s}px`,r.left=u==="left"?"0":u==="center"?"50%":"",r.right=u==="right"?"0":"",r.transform+=u==="center"?"translateX(-50%)":"",r.top=l==="top"?"0":l==="bottom"?"":"50%",r.bottom=l==="bottom"?"0":"",r.transform+=l==="center"?"translateY(-50%)":"",a},q=["x","y","z","nx","ny","nz"],$={container:document.body,placement:"top-right",size:128,lineWidth:3,offset:{top:0,left:0,right:0,bottom:0},font:{family:"helvetica",weight:900},resolution:64,backgroundSphere:{enabled:!0,color:16777215,opacity:.2},x:{text:"X",colors:{main:"#ff3653"}},y:{text:"Y",colors:{main:"#8adb00"}},z:{text:"Z",colors:{main:"#2c8fff"}},nx:{drawLine:!1,colors:{main:"#ff3653"}},ny:{drawLine:!1,colors:{main:"#8adb00"}},nz:{drawLine:!1,colors:{main:"#2c8fff"}}},v=new n.Color,j=t=>{const e=[],i=[];q.forEach((r,o)=>{const s=t[r];if(s.drawLine===!1)return;const c=o<3?1:-1,h=o<3?.9:1.025;e.push(r.includes("x")?h*c:0,r.includes("y")?h*c:0,r.includes("z")?h*c:0,0,0,0);const l=s.colors.main,[u,m]=Array.isArray(l)?l:[l,l];i.push(...v.set(m).toArray(),...v.set(u).toArray())});const a=new n.BufferGeometry;return a.setAttribute("position",new n.BufferAttribute(new Float32Array(e),3)),a.setAttribute("color",new n.BufferAttribute(new Float32Array(i),3)),new n.LineSegments(a,new n.LineBasicMaterial({linewidth:t.lineWidth??3,vertexColors:!0}))},Q=t=>{const e=typeof t=="string"?document.querySelector(t):t;if(!e)throw Error("Invalid DOM element");return e};function G(t){const e=new n.SphereGeometry(1.6,64,64);return new n.Mesh(e,new n.MeshBasicMaterial({color:t,side:n.BackSide,transparent:!0,opacity:0,depthTest:!1}))}function X(t,e,i,a,r,o,s,c){const h=document.createElement("canvas");e=e??64;const l=.02;h.width=e*2+e*(l*4),h.height=e+e*(l*2);const u=e/2,m=e/2+e*l,P=m*3,f=h.getContext("2d");if(D(f,u,m,m,i,c),D(f,u,P,m,o||"#FFF",c),a!=null){const C=t.family||"sans-serif",w=t.weight||500,V=Y(f,a,C,w,e);f.textAlign="center",f.textBaseline="middle",f.fillStyle=r||"#000",f.fillText(a,m,m+V),f.fillStyle=s||r||"#000",f.fillText(a,P,m+V)}const S=new n.CanvasTexture(h);return S.colorSpace=n.SRGBColorSpace,S.wrapS=S.wrapT=n.RepeatWrapping,S.repeat.x=.5,new n.SpriteMaterial({map:S,toneMapped:!1,transparent:!0})}function D(t,e,i,a,r,o=!1){const s=a*.1;e=o?e-s:e,o&&(t.globalAlpha=.2),t.beginPath(),t.arc(i,a,e,0,2*Math.PI),t.closePath(),t.fillStyle=r,t.fill(),o&&(t.globalAlpha=1,t.strokeStyle=r,t.lineWidth=s,t.stroke())}function Y(t,e,i,a,r){const o=Math.sqrt(Math.pow(r*.7,2)/2);let s=o,c=0,h=0;do{t.font=`${a} ${s}px ${i}`;const m=t.measureText(e);c=m.width,h=m.fontBoundingBoxDescent,s--}while(c>o&&s>0);const l=Math.min(o/c,o/h),u=Math.floor(s*l);return t.font=`${a} ${u}px ${i}`,o/h}function H(t){const{font:e,resolution:i}=t;return q.map((a,r)=>{const{text:o,colors:s,border:c}=t[a],h=r<3,l=h?a:a[1],{text:u,main:m,hover:P,hoverText:f}=s,S=Array.isArray(m)?m[1]:m,C=c&&o,w=new n.Sprite(X(e,i,v.set(S).getStyle(),o,u&&v.set(u).getStyle()||null,P&&v.set(P).getStyle()||null,f&&v.set(f).getStyle()||null,c));return w.userData.type=a,w.userData.forceScale=C,w.scale.setScalar(C||h?.6:.4),w.position[l]=h?1.2:-1.2,w.renderOrder=1,w})}const E=new n.Object3D;function W(t,e,i){g.multiplyScalar(e.value).add(i),E.position.copy(i),E.lookAt(t.position),_.copy(E.quaternion),E.lookAt(g),A.copy(E.quaternion)}function O(t,e,i){e.value=t.position.distanceTo(i)}function Z(t,e,i,a){switch(i){case"x":g.set(1,0,0),y.setFromEuler(new n.Euler(0,Math.PI*.5,0));break;case"y":g.set(0,1,0),y.setFromEuler(new n.Euler(-Math.PI*.5,0,0));break;case"z":g.set(0,0,1),y.setFromEuler(new n.Euler);break;case"nx":g.set(-1,0,0),y.setFromEuler(new n.Euler(0,-Math.PI*.5,0));break;case"ny":g.set(0,-1,0),y.setFromEuler(new n.Euler(Math.PI*.5,0,0));break;case"nz":g.set(0,0,-1),y.setFromEuler(new n.Euler(0,Math.PI,0));break;default:console.error("ViewHelper: Invalid axis.")}O(t,a,e),W(t,a,e)}const x=new n.Vector3;function N(t,e){x.set(0,0,1),x.applyQuaternion(e.quaternion),x.x>=0?(t[0].material.opacity=1,t[3].material.opacity=.5):(t[0].material.opacity=.5,t[3].material.opacity=1),x.y>=0?(t[1].material.opacity=1,t[4].material.opacity=.5):(t[1].material.opacity=.5,t[4].material.opacity=1),x.z>=0?(t[2].material.opacity=1,t[5].material.opacity=.5):(t[2].material.opacity=.5,t[5].material.opacity=1)}function U(t,e,i=10){return Math.abs(t.clientX-e.x)<i&&Math.abs(t.clientY-e.y)<i}function k(t){let e=t.length;for(;e--;)t[e].scale.setScalar(e<3||t[e].userData.forceScale?.6:.4),t[e].material.map.offset.x=1}const z=new n.Vector2;function J(t,e,i){z.x=(t.clientX-e.left)/e.width*2-1,z.y=-((t.clientY-e.top)/e.height)*2+1,T.setFromCamera(z,i)}function F(t,e,i,a){J(t,e,i);const r=T.intersectObjects(a);return r.length?r[0].object:null}function K(t,e,i){return Math.min(Math.max(t,e),i)}const g=new n.Vector3,y=new n.Quaternion,_=new n.Quaternion,A=new n.Quaternion,T=new n.Raycaster,R=new n.Clock,tt=new n.Euler,et=2*Math.PI,I=new n.Vector2,L=new n.Vector2,M={value:0};let B=0;class it extends n.Object3D{constructor(i,a,r){super();d(this,"_backgroundSphere");d(this,"_bgSphereOpacity",.2);d(this,"_spritePoints");d(this,"_container");d(this,"_domRect");d(this,"_viewport",new n.Vector4);d(this,"_renderer");d(this,"_orthoCamera",new n.OrthographicCamera(-1.8,1.8,1.8,-1.8,0,4));d(this,"_domElement");d(this,"enabled",!0);d(this,"camera");d(this,"animated",!0);d(this,"animating",!1);d(this,"target",new n.Vector3);d(this,"dragging",!1);d(this,"size");d(this,"speed",1);this._renderer=a,this._container=a.domElement,this.camera=i,this._orthoCamera.position.set(0,0,2),r=Object.assign($,r||{});const{container:o,placement:s,size:c,offset:h,backgroundSphere:l}=r;this.size=c;const u=j(r);this._spritePoints=H(r),this.add(u,...this._spritePoints),l.enabled&&(this._backgroundSphere=G(l.color),this._bgSphereOpacity=l.opacity??.2,this.add(this._backgroundSphere)),this._domElement=b(s,c,h),Q(o).appendChild(this._domElement),this._domRect=this._domElement.getBoundingClientRect(),this._startListening(),this.update()}render(){this.animating&&this._animate();const i=this._domRect.left,a=B-this._domRect.bottom,r=this._renderer.autoClear;this._renderer.autoClear=!1,this._renderer.setViewport(i,a,this.size,this.size),this._renderer.clear(!1,!0,!1),this._renderer.render(this,this._orthoCamera),this._renderer.setViewport(this._viewport),this._renderer.autoClear=r}update(){this._domRect=this._domElement.getBoundingClientRect(),B=this._container.offsetHeight,O(this.camera,M,this.target),this._renderer.getViewport(this._viewport),this._updateOrientation()}dispose(){this.children.forEach(i=>{var r,o,s,c;const a=i;(r=a.material)==null||r.dispose(),(s=(o=a.material)==null?void 0:o.map)==null||s.dispose(),(c=a.geometry)==null||c.dispose()}),this._domElement.remove()}_updateOrientation(i=!0){i&&(this.quaternion.copy(this.camera.quaternion).invert(),this.updateMatrixWorld()),N(this._spritePoints,this.camera)}_animate(){if(!this.animated){this.camera.quaternion.copy(y),this.animating=!1,this.dispatchEvent({type:"change"}),this.dispatchEvent({type:"end"});return}const a=R.getDelta()*et*this.speed;_.rotateTowards(A,a),this.camera.position.set(0,0,1).applyQuaternion(_).multiplyScalar(M.value).add(this.target),this.camera.quaternion.rotateTowards(y,a),this._updateOrientation(),requestAnimationFrame(()=>this.dispatchEvent({type:"change"})),_.angleTo(A)===0&&(this.animating=!1,this.dispatchEvent({type:"end"}))}_setOrientation(i){Z(this.camera,this.target,i,M),this.animating=!0,R.start(),this.dispatchEvent({type:"start"})}_startListening(){this._domElement.onpointerdown=i=>this._onPointerDown(i),this._domElement.onpointermove=i=>this._onPointerMove(i),this._domElement.onpointerleave=()=>this._onPointerLeave()}_onPointerDown(i){if(!this.enabled)return;const a=s=>{!this.dragging&&U(s,I)||(this.dragging||(k(this._spritePoints),this.dragging=!0),L.set(s.clientX,s.clientY).sub(I).multiplyScalar(1/this._domRect.width*Math.PI),this.rotation.x=K(o.x+L.y,Math.PI/-2+.001,Math.PI/2-.001),this.rotation.y=o.y+L.x,this.updateMatrixWorld(),_.copy(this.quaternion).invert(),this.camera.position.set(0,0,1).applyQuaternion(_).multiplyScalar(M.value).add(this.target),this.camera.rotation.setFromQuaternion(_),this._updateOrientation(!1),this.dispatchEvent({type:"change"}))},r=()=>{if(document.removeEventListener("pointermove",a,!1),document.removeEventListener("pointerup",r,!1),!this.dragging)return this._handleClick(i);this.dragging=!1,this.dispatchEvent({type:"end"})};if(this.animating===!0)return;i.preventDefault(),I.set(i.clientX,i.clientY);const o=tt.copy(this.rotation);O(this.camera,M,this.target),document.addEventListener("pointermove",a,!1),document.addEventListener("pointerup",r,!1),this.dispatchEvent({type:"start"})}_onPointerMove(i){!this.enabled||this.dragging||(this._backgroundSphere&&(this._backgroundSphere.material.opacity=this._bgSphereOpacity),this._handleHover(i))}_onPointerLeave(){!this.enabled||this.dragging||(this._backgroundSphere&&(this._backgroundSphere.material.opacity=0),k(this._spritePoints),this._domElement.style.cursor="")}_handleClick(i){const a=F(i,this._domRect,this._orthoCamera,this._spritePoints);a&&(this._setOrientation(a.userData.type),this.dispatchEvent({type:"change"}))}_handleHover(i){const a=F(i,this._domRect,this._orthoCamera,this._spritePoints);k(this._spritePoints),a?(a.material.map.offset.x=.5,a.scale.multiplyScalar(1.2),this._domElement.style.cursor="pointer"):this._domElement.style.cursor=""}}p.ViewportGizmo=it,p.q1=_,p.q2=A,p.raycaster=T,p.targetPosition=g,p.targetQuaternion=y,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=three-viewport-gizmo.umd.cjs.map
